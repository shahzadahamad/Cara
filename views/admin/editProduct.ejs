<%- include('../layouts/header.ejs') -%>

  <link rel="stylesheet" href="/styleSheet/admin.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">

  <style>
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
    }
  </style>

  <div class="sidebar">
    <br>
    <ul class="menu">
      <li>
        <a href="/admin/dashboard">
          <i class="fa-solid fa-gauge-high"></i>
          <span>Dashboard</span>
        </a>
      </li>
      <li>
        <a href="/admin/profile">
          <i class="fas fa-user"></i>
          <span>Profile</span>
        </a>
      </li>
      <li>
        <a href="/admin/user-detials">
          <i class="fa-solid fa-users"></i>
          <span>Users</span>
        </a>
      </li>
      <li>
        <a href="/admin/order-detials">
          <i class="fa-solid fa-check"></i>
          <span>Order</span>
        </a>
      </li>
      <li class="active">
        <a href="/admin/products">
          <i class="fa-solid fa-cart-shopping"></i>
          <span>Products</span>
        </a>
      </li>
      <li>
        <a href="/admin/category">
          <i class="fa-solid fa-list"></i>
          <span>Category</span>
        </a>
      </li>
      <li>
        <a href="/admin/coupon">
          <i class="fa-solid fa-ticket"></i>
          <span>Coupons</span>
        </a>
      </li>
      <li>
        <a href="/admin/offer">
          <i class="fa-solid fa-percent"></i>
          <span>Offers</span>
        </a>
      </li>
      <li class="logout">
        <a href="/admin/category">
          <i class="fas fa-sign-out-alt"></i>
          <span>Logout</span>
        </a>
      </li>
    </ul>
  </div>

  <div class="main--content">

    <div class="header--wrapper">
      <img src="/images/logo.png" style="width: 140px; height: 40px;" alt="">
      <div class="user--info">
        <img src="/images/productImages/<%= admins.profile %>" alt="">
        <h4>
          <%= admins.username %>
        </h4>
      </div>
    </div>

    <section style="border-radius: 10px; min-height: 1010px;
    height: fit-content;
    padding: 1rem;" id="forms">
      <div style="width: 80%;" id="wrapper">
        <div class="title">
          <span>Edit Product</span>
        </div>
        <% if( locals.message ){ %>
          <div style="color: green; text-align: center; font-weight: 900;" class="detials" id="hide">
            <%=message%>
          </div>
          <% } %>
            <% if( locals.message1 ){ %>
              <div style="color: red; text-align: center; font-weight: 900;" class="detials" id="hide">
                <%=message1%>
              </div>
              <% } %>
                <form action="/admin/edit-products?id=<%= product._id %>" method="post" enctype="multipart/form-data">
                  <div class="row">
                    <i class="fa-solid fa-signature"></i>
                    <input type="text" name="name" placeholder="Name" value="<%= product.name %>" required>
                  </div>
                  <div class="row">
                    <i class="fa-solid fa-b"></i>
                    <input type="text" name="brand" placeholder="Brand" value="<%= product.brand %>" required>
                  </div>
                  <div class="row">
                    <i class="fa-solid fa-list"></i>
                    <select style="color: #787978; padding-left: 60px;" class="border rounded" name="category" required>
                      <option>
                        <%= product.categoryId.name %>
                      </option>
                      <% if(category.length> 0){ %>
                        <% for(let i=0; i< category.length; i++){ %>
                          <option>
                            <%= category[i].name %>
                          </option>
                          <% } %>
                            <% } else { %>
                              <option>No Category</option>
                              <% } %>
                    </select>
                  </div>
                  <div class="row">
                    <i class="fa-solid fa-dollar-sign"></i>
                    <input type="number" name="price" placeholder="Price" value="<%= product.price %>" required>
                  </div>
                  <div class="row">
                    <i class="fa-solid fa-star"></i>
                    <select style="color: #787978; padding-left: 60px;" class="border rounded " name="rating" required>
                      <option>
                        <%= product.rating %>
                      </option>
                      <% for(let i=1; i<=5; i++){ %>
                        <option>
                          <%= i %>
                        </option>
                        <% } %>
                    </select>
                  </div>
                  <div class="row">
                    <i class="fa-solid fa-c"></i>
                    <input type="number" name="quantity" placeholder="Quantity" value="<%= product.quantity %>"
                      required>
                  </div>


                  <label for="">Product Images</label>
                  <div class="border p-3 d-flex justify-content-between flex-wrap">
                    <% for(let i=0; i< product.image.length ; i++){ %>
                      <div class="image-container" id="imageContainer<%= i %>"
                        style="position: relative; margin-bottom: 20px;">
                        <img src="/images/productImages/<%= product.image[i] %>" alt="Image <%= i %>" id="imag<%=i%>"
                          class="imgView" style="width: 130px; height: auto; margin-bottom: 10px;border-radius: 10px;">
                        <i onclick="deleteImages('<%= i %>','<%= product._id %>')"
                          style="position: absolute; top: 5px; right: 5px;" class="fa-solid fa-xmark"></i>
                        <div class="button-container" style="position: relative; text-align: center;">
                          <button style="margin-top: 5px;" class="btn btn-outline-success p-1"
                            onclick="changeImage('<%= i %>','<%= product._id %>')">Change</button>
                        </div>
                      </div>
                      <%}%>

                  </div>
                  <br>
                  <div id="fileInputContainer" style="display: flex; justify-content: center; align-items: center;">
                    <button class="btn btn-outline-success " onclick="addImages('<%= product._id %>')">Add
                      Image</button>
                  </div>

                  <p style="display: none; color: red; font-weight: 900; margin: 0px;" id="errMsg"></p>
                  <br>





                  <div class="row-des">
                    <label for="">Description</label>
                    <textarea name="description" id="" aria-valuenow="<%= product.description %>" cols="30"
                      rows="5"><%= product.description %></textarea>
                  </div>
                  <div class="row button">
                    <input type="submit" value="Edit">
                  </div>
                  <div class="signup-link"> <a href="/admin/products">Go Back</a></div>
                </form>
      </div>
    </section>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>


  <script>

    function addImages(productId) {
      event.preventDefault();
      const fileInputContainer = document.getElementById('fileInputContainer');
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = 'image/*';
      fileInput.style.display = 'none';


      fileInputContainer.appendChild(fileInput);


      fileInput.click();


      fileInput.addEventListener('change', function () {
        const file = fileInput.files[0];
        if (file) {
          const formData = new FormData();
          formData.append('img', file);
          axios.post(`/admin/add-images?id=${productId}`, formData)
            .then(response => {
              if (response.data.status) {
                Swal.fire({
                  icon: 'success',
                  title: 'Image Added!',
                  showConfirmButton: false,
                  timer: 1000,
                })
                setTimeout(() => {
                  window.location.reload('/admin/edit-products')
                }, 1100);
              }
            })
            .catch(error => {
              console.log('error')
              console.error(error.message);
            });
        }
        fileInputContainer.removeChild(fileInput);
      });
    }

    function changeImage(i, id) {
      event.preventDefault();

      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = 'image/*';
      fileInput.addEventListener('change', function () {
        const file = fileInput.files[0];
        const reader = new FileReader();

        reader.onload = async function (e) {
          const imgView = document.getElementById(`imag${i}`)
          imgView.src = e.target.result;
          const formData = new FormData();
          formData.append('img', file);
          try {
            const response = await axios.patch(`/admin/edit-images?index=${i}&id=${id}`, formData);
            if (response.data.status) {
              Swal.fire({
                icon: 'success',
                title: 'Image Changed!',
                showConfirmButton: false,
                timer: 1000,
              })
            }
          } catch (error) {
            console.log(error.message);
          }
        };

        reader.readAsDataURL(file);
      });

      fileInput.click();
    }

    async function deleteImages(i, id) {
      const imageContainer = document.getElementById(`imageContainer${i}`);
      const errMsg = document.getElementById('errMsg');
      Swal.fire({
        title: "Are you sure?",
        text: "You won't be able to revert this!",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
        confirmButtonText: "Yes, remove it!"
      }).then( async (result) => {
        if (result.isConfirmed) {
          const response = await axios.delete('/admin/deleteImage', { data: { i, id } });
          if (response.data.status) {
            if (imageContainer) {
              imageContainer.remove();
            }
            Swal.fire({
            title: "Removed!",
            text: "Your file has been removed.",
            showConfirmButton: false,
            icon: "success",
            timer: 800,
          });
          } else {
            errMsg.style.display = 'block';
            errMsg.innerHTML = 'At least one image is require!';
          }
        }
      });

    }

  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


  <script src="/javaScript/script.js"></script>


  <%- include('../layouts/footer.ejs') -%>